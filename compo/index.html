<title>COPTER3D</title><style>*{margin:0;padding:0}</style><canvas id=C style=background:#000></canvas><script src=micro3d.js></script><script>var HELP="EVAC Copter OS 1.0\n********************\nFind the cars in distress\nLand near them to evacuate survivors\nCarry them to nearest hospitalw\nGood luck".split("\n"),HELP_KEYS="[Mouse]=steering  [W][S]=thrust  [Space]=Turbo  [A][D]=Roll  [Q][E]=Lean  [F]=Display  [L]=Quality",L3D=LINES3D,P3D=POINTS3D,S3D=SHAPE3D,Z3=[0,0,0],RND=RANDOM,CDX=0,CDY=0,AP=Array.prototype;AP.p=AP.push,AP.random=()=>this[0|RAND(this.length)];var ACX=0,BUF=0,ADEST=0,AVOL=0,AT=0,ACHANNELS=[],READY=0,ASEQS=[[80,82,81,85,83],[80,80,82,80,84,84,85,85],[90,92,94,96,98,100],[70,69,68,67,66,65,64,63,62,61,60,59]],ASEQI=0,TALERT=0;PM=M4(),PPOS=PM.subarray(12,15),PFRONT=PM.subarray(8,11),PPOSXZ=V3(),PVEL=V3(Z3),PYAW=0,PPOWER=.5,PFORCE=0,PFUEL=1,PTURB=0,SHK=0,LIVES=4,HP=1,LOADED=0,PERSON=0,SCORE=0,TARGETS=[],ZOOM=1,ZL=[1,200,70,40,15],look=0,F=0,PREV=TIME(),NOW=PREV,Q=1,NBLOCKS=0,NDOTS=0,GTIME=0,NTIME=0,NTARGET=0;var eye=V3(),center=V3(),up=V3(),FOV=65;NEWCHANNEL=()=>{var P=ACX.createOscillator(),S=ACX.createBufferSource(),r=ACX.createBiquadFilter(),E=ACX.createGain();P.frequency.value=0,S.buffer=BUF,S.loop=!0,r.frequency.value=1e4,E.gain.value=0,P.connect(E),S.connect(r),r.connect(E),E.connect(AVOL);var e={osc:P,noise:S,filter:r,gain:E};return ACHANNELS.p(e),e},STARTAUDIO=()=>{ACX=new AudioContext,ADEST=ACX.destination,(AVOL=ACX.createGain()).gain.value=.5,AVOL.connect(ADEST);var P=2*ACX.sampleRate;BUF=ACX.createBuffer(1,P,ACX.sampleRate),data=BUF.getChannelData(0);for(var S=0;S<P;S++)data[S]=2*RANDOM()-1;for(S=0;S<3;++S)NEWCHANNEL();ACHANNELS[0].noise.start(),ACHANNELS[1].osc.start(),ACHANNELS[2].noise.start()};var dash=[[-3,-1,0],[3,-1,0],[4,-5,0],[2,-5,0],[2,-7,0],[-2,-7,0],[-2,-5,0],[-4,-5,0]];sqr=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]],glyV=[[0,2,0],[1,2,0],[0,1,0],[1,1,0],Z3,[1,0,0],[.5,1,0]],glyI=[[0,1,5,4,0],[2,1,5],[0,1,3,2,4,5],[0,1,2,5,4],[3,2,1,5],[1,0,2,3,5,4],[1,2,4,5,3,2],[0,1,4],[0,1,4,5,0],[3,2,0,1,5],[4,0,5,1],[1,0,2,3,2,4,5],[1,0,2,3,5,4],[0,4,6,5,1]],glys=[];for(var i=0;i<14;++i){var n=[];glys.p(n);for(var j=0;j<glyI[i].length;++j)n.p(glyV[glyI[i][j]])}circle=[],circleY=[],circle4=[],circleR=[],stars=[],blocks={},grid=[];for(i=0;i<2*PI;i+=2*PI/100){var x=SIN(i),y=COS(i);circle.p(V3([x,y,0])),circleY.p(V3([x,0,y])),circle4.p(V3([SIN(i/4),0,COS(i/4)]))}for(i=1.4*PI;i<2.6*PI;)circleR.p(V3([SIN(i)*RAND(100,128),.5*RND(),COS(i)*RAND(100,128)])),i+=.03*RND();for(i=0;i<200;++i){var v=V3([RND()-.5,.4*(RND()-.5),RND()-.5]);v[1]<0&&(v[1]*=-1),stars.p(NORM(v,v))}var HOSPs=[[279,0,243],[581,0,465],[700,0,158],[848,0,414]],cars=[],Ps=[],roads=[],SMK=[],clouds=[],lightsW=[],lightsR=[];PM.set(HOSPs[0],12),INPUT(C),ADDL=(P,S)=>{var r=FLOOR(P[0]/64),E=FLOOR(P[2]/64),e=blocks[r+":"+E];e||(e=blocks[r+":"+E]={l:[]}),S?e.l.splice(FLOOR(e.l.length*RND()),0,P):e.l.p(P)},NEWROAD=(P,S,r,E,e,A)=>{var R=DIST(P,S);if(R>100){var T=LERPV3(V3(),P,S,.5);return NEWROAD(P,T,r,E,e,A),void NEWROAD(T,S,r,E,e,A)}roads.p(P,S),A=A||.5;for(var O=0;O<=R*A;++O){var t=LERPV3(V3(),P,S,(O+(e?RAND(.1,-.05):0))/(R*A));e&&(t=t.ADD([RAND(.1,-.05),.2,RAND(.1,-.05)])),r?r.p(t):ADDL(t,E)}},EMIT=(P,S,r)=>{var E=[V3(P),V3(S),r];return Ps.p(E),E};var city={lights:[],clouds:[]},lastR=roads.length;function extraWorld(){NEWROAD(V3([100,0,-1]),V3([150,0,-1]),lightsW),NEWROAD(V3([100,0,0]),V3([150,0,0]),lightsW,0,0,.5),NEWROAD(V3([100,0,1]),V3([150,0,1]),lightsW),NEWROAD(V3([98,0,-2.5]),V3([98,0,2.5]),lightsR);for(var P=0;P<HOSPs.length;++P){var S=HOSPs[P];NEWROAD(V3([-1.5,0,1]).ADD(S),V3([1.5,0,1]).ADD(S),lightsW,0,0,2),NEWROAD(V3([-1.5,0,-1]).ADD(S),V3([1.5,0,-1]).ADD(S),lightsW,0,0,2),NEWROAD(V3([.1,0,1]).ADD(S),V3([.1,0,-1]).ADD(S),lightsW,0,0,2)}}function SINGLEPOINTS3D(P,S,r,E){if(P&&P.length){S?MULTMAT4(MVP_M4,VP_M4,S):MVP_M4.set(VP_M4);for(var e=TEMPV4,A=VP_DATA,R=2,T=(r=r||1,0),O=P.length;T<O;T+=r)PROJ3D(e,MVP_M4,P[0|T]),e[0]<-.1||e[0]>1.1||e[1]<-.1||e[1]>1.1||e[2]>1||(R=PSIZE/POW(e[3],.8)*(E?1:1+T%3/3),CX.fillRect(REMAP(e[0],0,1,A[0],A[0]+A[2])-R/2,REMAP(e[1],1,0,0,A[1]+A[3])-R/2,R,R))}}fetch("barna.bin").then((P=>P.arrayBuffer())).then((P=>{for(var S=new Int16Array(P),r=0;r<S.length;r+=4)NEWROAD(V3([S[r]/2,0,S[r+1]/2]),V3([S[r+2]/2,0,S[r+3]/2]),0,1,1);lastR=roads.length,TARGETS=[],extraWorld()}));for(var ix=-8;ix<=8;++ix)for(var iz=-8;iz<=8;++iz)grid.p(V3([ix,0,iz]));loop=()=>{NBLOCKS=NDOTS=0,requestAnimationFrame(loop);var P=MOUSE.buttons,S=(MOUSE.pos[0]/C.width-.5)*(P?1:.5),r=(MOUSE.pos[1]/C.height-.5)*-(P?1:.5);P?READY||(READY=1,Ps.length=GTIME=0,!ACX&&LIVES&&STARTAUDIO(),NTIME=10):(CDX=S,CDY=r),NOW=TIME(),F++;var E=MIN(.1,NOW-PREV);PREV=NOW,GTIME+=E,NTIME-=E,C.width=BODY.offsetWidth,C.height=BODY.offsetHeight,INIT(C),CX.lineWidth=2,CX.globalCompositeOperation="lighter",READY?GTIME<10&&(COLOR(6,2-PPOS[1]),CX.font="14px Arial",CX.textAlign="left",CX.fillText(HELP_KEYS,10,20)):(COLOR(6,(GTIME-2)/4),CX.font="200px Verdana",CX.textAlign="center",CX.fillText("EVAC3D",.5*C.width-8*MAX(0,5-NOW),.5*C.height),COLOR(0,1),CX.globalCompositeOperation="source-over",CX.fillText("EVAC3D",.5*C.width+4,.5*C.height+4),COLOR(6,(GTIME-6)/6),CX.font="30px Verdana",CX.textAlign="left",COLOR(8,.5*(GTIME-6)),CX.fillText("by @TAMAT for the #JK13K 2022",.5*C.width-240,C.height-40),F%2==0&&EMIT([410,0,240],[RAND(1,-.2)/3,.5+RAND(1),RAND(1,-.5)/3],8));var e=POW(1-SATURATE(GTIME/2-4),3);MAT4xV3(eye,PM,[0,.1,0]),MAT4xV3(up,PM,UP),SUB(up,up,eye),MAT4xV3(center,PM,[S*(1-e)+look,r*(1-e)+RAND(SHK),-1]),SHK*=.9,SCALE(PPOSXZ,PPOS,[1,0,1]),READY?(FOV=LERP(65,40,e),center[1]=LERP(center[1],0,e)):(eye=[50*SIN(NOW/9)+400,30,50*COS(NOW/8)+200],center=[410,0,200],up=[0,1,0]),CAMERA(eye,center,up,FOV,C.width/C.height,.1,500),COLOR(LIVES?"#AAC":1,1);var A=TMAT4(M4(),eye);PSIZE=1,LIVES?P3D(stars,A):L3D(stars,A),Q&&(COLOR(2),P3D(circleY,A,1),COLOR(8,.4),PSIZE=50,P3D(circleR)),PPOS[1]<4&&(COLOR(1,.3-.05*PPOS[1]),PSIZE=10,P3D(grid,TMAT4(M4(),[FLOOR(PPOS[0]),0,FLOOR(PPOS[2])]),1,1));for(var R=FLOOR(PPOS[0]/64),T=FLOOR(PPOS[2]/64),O=Q?6:3,t=-O+R;t<=O+R;t++)for(var i=-O+T;i<=O+T;i++){var D=64*t,a=64*i,l=DIST(PPOS,[D,PPOS[1],a]),o=blocks[t+":"+i];if(o&&CAMTESTBOX([D+32,0,a+32],[32,1,32])){NBLOCKS++;var L=o.l.length;l>750?L*=.25:l>500?L*=.5:l>250&&(L*=.75),Q&&(COLOR(8,.03),PSIZE=300,SINGLEPOINTS3D(o.l,0,1,0,L/4)),COLOR(8,.7),PSIZE=40,P3D(o.l,0,1,0,L),NDOTS+=L*(Q?1.5:1)|0}}cars=[];for(var M=0;M<lastR;M+=2){var N=roads[M],n=roads[M+1];if(!(DIST(eye,LERPV3(TEMPV3,N,n,.5))>150))for(var I=0,c=(l=DIST(N,n))>>1;I<=c;I++)X=FRACT((.3*NOW+I+SIN(123*I+.1*NOW))/c),cars.p(LERPV3(V3(),N,n,X))}if(TARGETS.forEach((P=>cars.p(P.pos))),COLOR(1),P3D(lightsW),COLOR("#F33",1),P3D(lightsR),!READY&&(F/10|0)%2){A=SIN(GTIME/10);PSIZE=-4,P3D([LERPV3(V3(),HOSPs[0],[410,0,240],A)])}F%5||!lightsW.length||lightsW.unshift(lightsW.pop()),F%5||!lightsR.length||lightsR.unshift(lightsR.pop()),COLOR(1,.4),PSIZE=40,P3D(cars,0,1,1),CX.globalCompositeOperation="source-over",COLOR(2,.5),PSIZE=LIVES?100:10,SINGLEPOINTS3D(SMK,0,1,1),COLOR(2,.5),Q&&(PSIZE=200,SINGLEPOINTS3D(clouds)),PSIZE=50,SMK=[];for(var V=0;V<Ps.length;++V){var f=Ps[V];SMK.p(f[0]),ADD(f[0],f[0],f[1].SCALE(E)),f[2]-=E}if(Ps=Ps.filter((P=>P[2]>0)),TARGETS.forEach((P=>{!(F%10|0)&&P.time<100&&EMIT(P.pos,[RAND(1,-.2)/9,.2+RAND(1,-.5)/6,RAND(1,-.5)/9],20)})),PPOS[1]<2&&PFORCE>1&&HP&&EMIT([PPOS[0],0,PPOS[2]],[RAND(1,-.5),0,RAND(1,-.5)],4),HP<.2&&!(F%10)&&LIVES&&EMIT(PPOS,Z3,6),READY){LIVES&&(COLOR(8,1),S3D(circle4,TRS(0,[0,20,0],[0,POW(NOW,3),0],40,PM),1),S3D(circle4,TRS(0,[0,20,0],[0,POW(NOW,4)+PI/2,0],30,PM),1));var h=APPLYTRANS(M4(),PM,[0,3*e-2,-10]),p=TRS(0,[0,7,0],0,[.8,-1,.8],h);COLOR(0,1),S3D(dash,p),COLOR(2),S3D(dash,p,1,1);p=TRS(0,[0,-8,0],0,[1,3,1],h);COLOR(0,1),S3D(sqr,p),COLOR(2),S3D(sqr,p,1,1),COLOR(0,1),S3D(dash,h),COLOR(2),S3D(dash,h,1,1),PYAW=ATAN2(PFRONT[0],PFRONT[2]);var g=[],v=[];(PFUEL<.1&&(F/4|0)%2||PTURB>.1)&&v.p([0,-2.35,0]);var W=TARGETS.filter((P=>P.mode));for(V=0;V<W.length;++V)(W[V].time>50||F/2%2)&&v.p([-1.1-.2*V,-1.1,0]);g.p([-2.5,-2,0],[.5*SIN(PPOS[1])-2.5,.5*COS(PPOS[1])-2,0],[-2.5,-2,0],[.3*SIN(PPOS[1]/10)-2.5,.3*COS(PPOS[1]/10)-2,0],[0,-2,0],[.45*SIN(4.2*PFUEL-2.2),.45*COS(4.2*PFUEL-2.2)-2,0]);var d=.52;PSIZE=-2,S3D(circle,TRS(0,[-2.5,-2,0],0,d,h),1,1),P3D(circle,TRS(0,[-2.5,-2,0],0,d-.1,h),5,1),S3D(circle,TRS(0,[-1.25,-2,0],0,d,h),1,1),S3D(circle,TRS(0,[0,-2,0],0,d,h),1,1),Z=circle.slice(0,70),S3D(Z,TRS(0,[0,-2,0],[0,0,2.2],d-.05,h),1,1),P3D(Z,TRS(0,[0,-2,0],[0,0,2.2],.44,h),2,1),S3D(sqr,TRS(0,[2,-3,0],0,[1,.1,0],h),1,1),S3D(sqr,TRS(0,[2,-3.3,0],0,[1,.1,0],h),1,1),S3D(sqr,TRS(0,[2,-3.6,0],0,[1,.1,0],h),1,1),S3D(sqr,TRS(0,[1.9,-.6,0],0,[.5,.01,0],h)),S3D(sqr,TRS(0,[1.9,-.6,0],0,[.01,.5,0],h)),S3D(sqr,TRS(0,[-1.2,-3.8,0],0,[2,1,0],h),1,1),COLOR(3,.2),PSIZE=50;var u=TRS(0,[0,-.2,0],0,1,h);if(S3D(sqr,u),S3D(sqr,TRS(0,[1.9,-.6,0],0,.5,h)),TARGETS.forEach((P=>P.dist=DIST(P.pos,PPOS))),TARGETS.sort(((P,S)=>P.dist-S.dist)),NTARGET=TARGETS[0],COLOR("#585",1),LIVES||RND()>(LIVES&&HP<.25?.5:.9)){if((LOADED>=1||TARGETS[0]&&(TARGETS[0].dist>1.5||(F/8|0)%2==0))&&S3D(sqr,TRS(0,[0,-1.3,0],0,[CLAMP(4-TARGETS[0].dist,0,2),.02,.1],h)),GTIME>3.5){L3D(g,h,1);var U=TRS(0,[-1.25,-2,0],[0,0,-PYAW-PI/2],.1,h);S3D(glys[10],U.MULT(TMAT4(M4(),[-.5,2,0])),1),S3D(glys[11],U.MULT(TMAT4(M4(),[3,-1,0])),1),S3D(glys[12],U.MULT(TMAT4(M4(),[-.5,-4,0])),1),S3D(glys[13],U.MULT(TMAT4(M4(),[-4,-1,0])),1)}if(1==e){MULTMAT4(MVP_M4,VP_M4,h);var G=TOVIEWPORT(V3(),PROJ3D(V3(),MVP_M4,[-2.9,-3.1,0]));CX.font="20px Courier New";for(V=0;V<MIN(HELP.length,HELP.length*GTIME*.25|0);++V)CX.fillText(HELP[V],G[0],G[1]+20*V)}if(GTIME>8){var X=SATURATE(PPOWER/2);S3D(sqr,TRS(0,[1+X,-3,0],0,[X,.1,0],h)),S3D(sqr,TRS(0,[3*PTURB+1,-3.3,0],0,[3*PTURB,.1,0],h)),S3D(sqr,TRS(0,[HP+1,-3.6,0],0,[HP,.1,0],h)),DRAWNUM=(P,S,r)=>{for(var E=0;E<4;++E)S3D(glys[(P/POW(10,3-E)|0)%10],TRS(0,[S+E/2,r,0],0,.2,h),1)},DRAWNUM(SCORE,-2.4,-3.3)}CX.save(),S3D(sqr,APPLYSCALE(0,u,[.9,.9,.9]),0,0,1),s=ZL[ZOOM];var H=SMAT4(M4(),1/s).MULT(RMAT4(M4(),-PYAW,UP).MULT(TMAT4(M4(),[-PPOS[0],0,-PPOS[2]]))),y=TRS(0,Z3,[PI/2,0,0],1,u);y=y.MULT(H),ZOOM||(y=0,PSIZE=-8),GTIME>5&&L3D(roads,y,1),P3D(HOSPs,y),COLOR(1);var m=TARGETS.filter((P=>!P.incopter&&P.mode)).map((P=>P.time<100?P.pos:P.pos2));if(m[0]&&(10*NOW|0)%2==0&&P3D(m,y),ALPHA(.5),TARGETS.forEach((P=>{!P.incopter&&P.mode&&S3D(circleY,TRS(0,P.pos2,0,10,y),1,1)})),PSIZE=40,CX.restore(),COLOR(6,1),GTIME>3&&S3D(sqr,TRS(0,Z3,0,.03,u)),lvel=RMAT4(M4(),-PYAW,[0,1,0]).MULT(PVEL),S3D(sqr,TRS(0,[1.9+CLAMP(lvel[0]/1.5,-.5,.5),-.6-CLAMP(lvel[2]/1.5,-.5,.5),0],0,.02,h)),S3D(sqr,TRS(0,[1.45,-.6+CLAMP(PVEL[1],-.5,.5),0],0,[-.05,.02,0],h)),U=TRS(0,[2,-2,0],0,.5,h),PERSON){pulse=[];var Y=POW(CLAMP(PERSON.time/100,0,1),.4);for(V=0;V<40;++V)pulse.p(V3([V/20-1,CLAMP(SIN(V/5+NOW)*SIN(V/2+4*NOW)*Y,-.8,.8),0]));S3D(pulse,U,1)}for(V=0;V<LIVES;++V)v.p([1.2,V/4-2.4,0]);P3D(v,h,1,1),COLOR(2),S3D(sqr,U,1,1)}if(ACX){A=ACX.currentTime;var Z=0;TALERT-=E,copter=ACHANNELS[0],radio=ACHANNELS[1],turbo=ACHANNELS[2],copter.filter.frequency.linearRampToValueAtTime(300*PPOWER+1e3*SHK,A+.1),AT+=E*PFORCE*10+RANDOM()*SHK*10,Z=.4*FRACT(AT)+.2*SHK,copter.gain.gain.linearRampToValueAtTime(CLAMP(Z,0,1),A+.1);var K=TALERT>0?ASEQS[ASEQI][(10*NOW|0)%ASEQS[ASEQI].length]:0,q=440*POW(2,(K-69)/12);radio.osc.frequency.linearRampToValueAtTime(q,A+.1),radio.gain.gain.value=.5,turbo.filter.frequency.linearRampToValueAtTime(500*PTURB+4e3,A+.1),turbo.gain.gain.linearRampToValueAtTime(PTURB,A+.1)}if(LIVES){SPD=LEN(PVEL),PPOS[1]<0&&((SPD>.1||ABS(PFRONT[1])<-.5)&&(HP=MAX(0,HP-(.05+SPD/2)),SHK=4*SPD),TRS(PM,V3([PPOS[0],0,PPOS[2]]),[0,PYAW,0],1),PVEL.fill(0)),HP<=0&&(LIVES=0),angz=0,GTIME>6&&(KEYS.W&&(PPOWER+=.2*E),KEYS.S&&(PPOWER-=.2*E),KEYS.A&&(angz-=E/3),KEYS.D&&(angz+=E/3),KEYS.Space&&(PTURB=SATURATE(PTURB+2*E))),KEYS.Q?look=LERP(look,-1,.1):KEYS.E?look=LERP(look,1,.1):look=LERP(look,0,.1),KEYSP={};var x=M4(PM);if(x.set(Z3,12),PPOWER=CLAMP(PPOWER,0,2),PFORCE=LERP(PFORCE,PPOWER+3*PTURB,.2),PFUEL=MAX(0,PFUEL-(PPOWER+100*PTURB)*E*.001),PTURB*=.9,X=x.MULT([0,E*E*PFORCE*(PFUEL?25:0),0]),ADD(PVEL,PVEL,V3([0,-(24+LOADED+.5*PPOS[1])*E*E,0]).ADD(X)),SCALE(PVEL,PVEL,.995),PPOS[1]<=0&&(PVEL[1]=MAX(0,PVEL[1])),A=TMAT4(M4(),PVEL.SCALE(.2)),rx=RMAT4(M4(),.15*-CDX,[0,1,0]),rz=RMAT4(M4(),.1*CDX+angz,[0,0,-1]),ry=RMAT4(M4(),.05*CDY,[1,0,0]),B=MULTMAT4(M4(),rx,ry),MULTMAT4(B,rz,B),PPOS[1]>0&&MULTMAT4(PM,PM,B),MULTMAT4(PM,A,PM),NTARGET&&NTARGET.dist<1.5&&PPOS[1]<=0&&LOADED<1&&(LOADED+=E/2,LOADED>=1&&(NTARGET.incopter=1,PERSON=NTARGET,TARGETS.shift(),ASEQI=2,TALERT=.8)),TARGETS.forEach((P=>{P.time-=E,RANDOM()>.001&&!P.mode&&(P.mode=1,TALERT=.8,ASEQI=0),P.time<=0&&(LIVES--,NTIME<0&&(NTIME=10),P==PERSON&&(LOADED=PERSON=0),TALERT=.8,ASEQI=3)})),TARGETS=TARGETS.filter((P=>P.time>0)),TARGETS.length<4&&roads[0]&&NTIME<0){var B=2*(0|RAND(lastR/2)),b=LERPV3(V3(),roads[B],roads[B+1],RND()),k=b.ADD([16*(RANDOM()-.5),0,16*(RANDOM()-.5)]);TARGETS.p({pos:b,pos2:k,time:200+RAND(50),mode:0,incopter:0}),NTIME=30}INH=0;for(V=0;V<HOSPs.length;++V)INH|=DIST(PPOS,HOSPs[V])<2;PPOS[1]<=0&&INH&&(LOADED>=1&&PERSON&&(SCORE+=PERSON.time/2|0,PERSON=LOADED=0,TALERT=ASEQI=1),PFUEL=MIN(1,PFUEL+E/20))}else ACX&&(ACX.close(),ACX=0)}},loop(),ONKEY=P=>{if("keydown"==P.type)switch(P.code){case"KeyL":Q=!Q;break;case"KeyF":ZOOM=(ZOOM+1)%5}}</script>
