<!doctype html><title>COPTER3D</title><style>body,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden}</style><canvas id=C style=background:#000></canvas><script>var KEYS={},KEYSP={},MOUSE={pos:[0,0],delta:[0,0],buttons:0},CX=0,BODY=document.body;BODY.onkeydown=BODY.onkeyup=function(P){var A="keydown"==P.type,r="Key"==P.code.substr(0,3)?P.code.substr(3):P.code;KEYSP[r]=A&&!KEYS[r],KEYS[r]=A,window.ONKEY&&ONKEY(P)};var D2R=.0174532925,PSIZE=50,maths=Object.getOwnPropertyNames(Math);for(var i in maths)window[maths[i].toUpperCase()]=Math[maths[i]];CLAMP=(P,A,r)=>MIN(MAX(P,A),r),SATURATE=P=>CLAMP(P,0,1);var F32=Float32Array,F32P=F32.prototype,IDM4=new F32([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);F32P.MULT=function(P){return 16==P.length?MULTMAT4(M4(),this,P):16==this.length?MAT4xV3(V3(),this,P):V3([this[0]*P[0],this[1]*P[1],this[2]*P[2]])},F32P.ADD=function(P){return ADD(V3(),this,P)},F32P.SUB=function(P){return SUB(V3(),this,P)},F32P.SCALE=function(P){return SCALE(V3(),this,P)},PALETTE=["#000","#FFF","#333","#777","#AAA","#FAA","#AFA","#AAF","#FD9"],V3=P=>new F32(P||3),UP=V3([0,1,0]),M4=P=>new F32(P||IDM4);var VP_DATA=new F32(4),TEMPV3=V3(),TEMPV3B=V3(),TEMPV4=V3(4);INIT=P=>{CX=P.getContext("2d"),VP_DATA.set([0,0,P.width,P.height]),P.width=P.width,P.height=P.height},INPUT=P=>{P.onmousedown=P.onmouseup=P.onmousemove=function(P){MOUSE.delta[0]=P.pageX-MOUSE.pos[0],MOUSE.delta[1]=P.pageY-MOUSE.pos[1],MOUSE.pos[0]=P.pageX,MOUSE.pos[1]=P.pageY,MOUSE.buttons=P.buttons,window.ONMOUSE&&ONMOUSE(P)}},VIEWPORT=(P,A,r,S)=>{VP_DATA.set([P,A,r,S])},TIME=()=>.001*performance.now(),LERP=(P,A,r)=>P*(1-r)+A*r,ILERP=(P,A,r)=>(r-P)/(A-P),REMAP=(P,A,r,S,E)=>LERP(S,E,ILERP(A,r,P)),RAND=(P,A)=>RANDOM()*P+(A||0),FRACT=P=>P-FLOOR(P),ADD=(P,A,r)=>(P[0]=A[0]+r[0],P[1]=A[1]+r[1],P[2]=A[2]+r[2],P),SUB=(P,A,r)=>(P[0]=A[0]-r[0],P[1]=A[1]-r[1],P[2]=A[2]-r[2],P),SCALE=(P,A,r)=>(r.length?(P[0]=A[0]*r[0],P[1]=A[1]*r[1],P[2]=A[2]*r[2]):(P[0]=A[0]*r,P[1]=A[1]*r,P[2]=A[2]*r),P),DOT=(P,A)=>P[0]*A[0]+P[1]*A[1]+P[2]*A[2],CROSS=(P,A,r)=>{var S=A[0],E=A[1],T=A[2],e=r[0],R=r[1],t=r[2];return P[0]=E*t-T*R,P[1]=T*e-S*t,P[2]=S*R-E*e,P},LEN=P=>{var A=P[0],r=P[1],S=P[2];return SQRT(A*A+r*r+S*S)},LERPV3=(P,A,r,S)=>{for(var E=0;E<P.length;++E)P[E]=A[E]*(1-S)+r[E]*S;return P},NORM=(P,A)=>{var r=A[0],S=A[1],E=A[2],T=r*r+S*S+E*E;return T>0&&(T=1/SQRT(T),P[0]=A[0]*T,P[1]=A[1]*T,P[2]=A[2]*T),P},DIST=(P,A)=>{var r=A[0]-P[0],S=A[1]-P[1],E=A[2]-P[2];return SQRT(r*r+S*S+E*E)},TMAT4=(P,A)=>(P.set(IDM4),P[12]=A[0],P[13]=A[1],P[14]=A[2],P),RMAT4=(P,A,r)=>{var S,E,T,e=r[0],R=r[1],t=r[2],O=SQRT(e*e+R*R+t*t);return O<1e-4?null:(e*=O=1/O,R*=O,t*=O,S=SIN(A),T=1-(E=COS(A)),P[0]=e*e*T+E,P[1]=R*e*T+t*S,P[2]=t*e*T-R*S,P[3]=0,P[4]=e*R*T-t*S,P[5]=R*R*T+E,P[6]=t*R*T+e*S,P[7]=0,P[8]=e*t*T+R*S,P[9]=R*t*T-e*S,P[10]=t*t*T+E,P[11]=0,P[12]=0,P[13]=0,P[14]=0,P[15]=1,P)},SMAT4=(P,A)=>(A.constructor===Number&&(A=[A,A,A]),P.set(IDM4),P[0]=A[0],P[5]=A[1],P[10]=A[2],P),APPLYTRANS=(P,A,r)=>{var S=TMAT4(M4(),r);return MULTMAT4(P||S,A,S)},APPLYROT=(P,A,r,S)=>{var E=RMAT4(M4(),r,S);return MULTMAT4(P||E,A,E)},APPLYSCALE=(P,A,r)=>{var S=SMAT4(M4(),r);return MULTMAT4(P||S,A,S)},TRS=(P,A,r,S,E)=>{P=P||M4();var T=TMAT4(M4(),A),e=M4();r&&(r[0]&&APPLYROT(e,e,r[0],[1,0,0]),r[1]&&APPLYROT(e,e,r[1],[0,1,0]),r[2]&&APPLYROT(e,e,r[2],[0,0,1]));var R=SMAT4(M4(),S);return MULTMAT4(P,E||M4(),T),MULTMAT4(P,P,e),MULTMAT4(P,P,R)},MULTMAT4=(P,A,r)=>{var S=A[0],E=A[1],T=A[2],e=A[3],R=A[4],t=A[5],O=A[6],M=A[7],a=A[8],i=A[9],o=A[10],D=A[11],L=A[12],s=A[13],n=A[14],l=A[15],C=r[0],N=r[1],V=r[2],I=r[3];return P[0]=C*S+N*R+V*a+I*L,P[1]=C*E+N*t+V*i+I*s,P[2]=C*T+N*O+V*o+I*n,P[3]=C*e+N*M+V*D+I*l,C=r[4],N=r[5],V=r[6],I=r[7],P[4]=C*S+N*R+V*a+I*L,P[5]=C*E+N*t+V*i+I*s,P[6]=C*T+N*O+V*o+I*n,P[7]=C*e+N*M+V*D+I*l,C=r[8],N=r[9],V=r[10],I=r[11],P[8]=C*S+N*R+V*a+I*L,P[9]=C*E+N*t+V*i+I*s,P[10]=C*T+N*O+V*o+I*n,P[11]=C*e+N*M+V*D+I*l,C=r[12],N=r[13],V=r[14],I=r[15],P[12]=C*S+N*R+V*a+I*L,P[13]=C*E+N*t+V*i+I*s,P[14]=C*T+N*O+V*o+I*n,P[15]=C*e+N*M+V*D+I*l,P},LOOKAT=(P,A,r,S)=>{var E=void 0,T=void 0,R=void 0,t=void 0,O=void 0,M=void 0,a=void 0,i=void 0,o=void 0,D=void 0,L=A[0],s=A[1],n=A[2],l=S[0],C=S[1],N=S[2],V=r[0],I=r[1],c=r[2];return ABS(L-V)<1e-4&&ABS(s-I)<1e-4&&ABS(n-c)<1e-4?e(P):(a=L-V,i=s-I,o=n-c,E=C*(o*=D=1/SQRT(a*a+i*i+o*o))-N*(i*=D),T=N*(a*=D)-l*o,R=l*i-C*a,(D=SQRT(E*E+T*T+R*R))?(E*=D=1/D,T*=D,R*=D):(E=0,T=0,R=0),t=i*R-o*T,O=o*E-a*R,M=a*T-i*E,(D=SQRT(t*t+O*O+M*M))?(t*=D=1/D,O*=D,M*=D):(t=0,O=0,M=0),P[0]=E,P[1]=t,P[2]=a,P[3]=0,P[4]=T,P[5]=O,P[6]=i,P[7]=0,P[8]=R,P[9]=M,P[10]=o,P[11]=0,P[12]=-(E*L+T*s+R*n),P[13]=-(t*L+O*s+M*n),P[14]=-(a*L+i*s+o*n),P[15]=1,P)},PERSP=(P,A,r,S,E)=>{var T=1/TAN(A*D2R/2),e=void 0;return P[0]=T/r,P[1]=0,P[2]=0,P[3]=0,P[4]=0,P[5]=T,P[6]=0,P[7]=0,P[8]=0,P[9]=0,P[11]=-1,P[12]=0,P[13]=0,P[15]=0,null!=E&&E!==1/0?(e=1/(S-E),P[10]=(E+S)*e,P[14]=2*E*S*e):(P[10]=-1,P[14]=-2*S),P},TRANS3D=(P,A,r)=>{var S=A[0],E=A[1],T=A[2],e=r[3]*S+r[7]*E+r[11]*T+r[15];return e=e||1,P[0]=(r[0]*S+r[4]*E+r[8]*T+r[12])/e,P[1]=(r[1]*S+r[5]*E+r[9]*T+r[13])/e,P[2]=(r[2]*S+r[6]*E+r[10]*T+r[14])/e,P},PROJ3D=(P,A,r)=>{var S=r[0],E=r[1],T=r[2],e=A[0]*S+A[4]*E+A[8]*T+A[12],R=A[1]*S+A[5]*E+A[9]*T+A[13],t=A[2]*S+A[6]*E+A[10]*T+A[14],O=A[3]*S+A[7]*E+A[11]*T+A[15];return P[0]=(e/O+1)/2,P[1]=(R/O+1)/2,P[2]=(t/O+1)/2,P.length>3&&(P[3]=O),P},TOVIEWPORT=(P,A)=>{var r=VP_DATA;return P[0]=REMAP(A[0],0,1,r[0],r[0]+r[2]),P[1]=REMAP(A[1],1,0,0,r[1]+r[3]),P},MAT4xV3=(P,A,r)=>{var S=r[0],E=r[1],T=r[2];return P[0]=A[0]*S+A[4]*E+A[8]*T+A[12],P[1]=A[1]*S+A[5]*E+A[9]*T+A[13],P[2]=A[2]*S+A[6]*E+A[10]*T+A[14],P},ALPHA=P=>{CX.globalAlpha=P},COLOR=(P,A)=>{P.constructor===Number&&(P=PALETTE[0|P]),CX.fillStyle=CX.strokeStyle=P,null!=A&&(CX.globalAlpha=CLAMP(A,0,1))};var VIEW_M4=M4(),PROJ_M4=M4(),VP_M4=M4(),MVP_M4=M4(),FPLANES=0,CAM_EYE=V3(),CAM_CENTER=V3(),CAM_FRONT=V3(),CAM_RIGHT=V3();function POINTS3D(P,A,r,S,E){if(P&&P.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var T=TEMPV4,e=VP_DATA,R=2;r=r||1;CX.beginPath();for(var t=0,O=MIN(E||P.length,P.length);t<O;t+=r)PROJ3D(T,MVP_M4,P[0|t]),T[0]<-.1||T[0]>1.1||T[1]<-.1||T[1]>1.1||T[2]>1||T[2]<0||(R=PSIZE<0?-PSIZE:PSIZE/POW(T[3],.8)*(S?1:1+t%3/3))<.1||CX.rect(REMAP(T[0],0,1,e[0],e[0]+e[2])-R/2,REMAP(T[1],1,0,0,e[1]+e[3])-R/2,R,R);CX.fill()}}function SHAPE3D(P,A,r,S,E){if(P&&P.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var T=TEMPV3,e=VP_DATA;CX.beginPath();for(var R=0,t=P.length;R<t;R+=1)PROJ3D(T,MVP_M4,P[R]),T[0]<-1||T[0]>2||T[1]<-1||T[1]>2||T[2]>1||T[2]<-1||CX.lineTo(REMAP(T[0],0,1,e[0],e[0]+e[2]),REMAP(T[1],1,0,0,e[1]+e[3]));S&&CX.closePath(),E?CX.clip():r?CX.stroke():CX.fill()}}function LINES3D(P,A){if(P&&P.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var r=TEMPV3,S=TEMPV3B,E=VP_DATA;CX.beginPath();for(var T=0;T<P.length-1;T+=2)PROJ3D(r,MVP_M4,P[T]),PROJ3D(S,MVP_M4,P[T+1]),r[2]>1||r[2]<0||S[2]>1||S[2]<0||(CX.moveTo(REMAP(r[0],0,1,E[0],E[0]+E[2]),REMAP(r[1],1,0,0,E[1]+E[3])),CX.lineTo(REMAP(S[0],0,1,E[0],E[0]+E[2]),REMAP(S[1],1,0,0,E[1]+E[3])));CX.stroke()}}CAMERA=(P,A,r,S,E,T,e)=>{CAM_EYE.set(P),CAM_CENTER.set(A),SUB(CAM_FRONT,CAM_CENTER,CAM_EYE),NORM(CAM_FRONT,CAM_FRONT),CROSS(CAM_RIGHT,CAM_FRONT,r),NORM(CAM_RIGHT,CAM_RIGHT),LOOKAT(VIEW_M4,P,A,r),PERSP(PROJ_M4,S,E,T,e),MULTMAT4(VP_M4,PROJ_M4,VIEW_M4),EXTRACTPLANES(VP_M4)},EXTRACTPLANES=P=>{FPLANES=[];for(var A=0;A<6;++A){var r=A%2?1:-1,S=A>>1,E=new F32([P[3]+r*P[S],P[7]+r*P[4+S],P[11]+r*P[8+S],P[15]+r*P[12+S]]),T=LEN(E);if(T){for(S=0;S<4;++S)E[S]/=T;FPLANES.p(E)}}};var IS_OUTSIDE=0,IS_INSIDE=1,OVERLAPS=2;DISTTOPLANE=(P,A)=>DOT(P,A)+P[3],CAMTESTSPHERE=(P,A)=>{FPLANES||EXTRACTPLANES(VP_M4);for(var r,S=0,E=0;E<6;++E){if((r=DISTTOPLANE(FPLANES[E],P))<-A)return IS_OUTSIDE;r<=A&&(S=1)}return S?OVERLAPS:IS_INSIDE},PLANEOVERLAP=(P,A,r)=>{var S=ABS(r[0]*P[0])+ABS(r[1]*P[1])+ABS(r[2]*P[2]),E=DOT(P,A)+P[3];return E<=-S?0:E<=S?OVERLAPS:IS_INSIDE},CAMTESTBOX=(P,A)=>{FPLANES||EXTRACTPLANES(VP_M4);for(var r=0,S=0,E=0;E<6;++E){if(!(r=PLANEOVERLAP(FPLANES[E],P,A)))return 0;S+=2==r?1:0}return S?OVERLAPS:IS_INSIDE};var HELP="EVAC Copter OS 1.0\n********************\nFind the cars in distress\nLand near them to evacuate survivors\nCarry them to nearest hospitalw\nGood luck".split("\n"),HELP_KEYS="[Mouse]=steering  [W][S]=thrust  [Space]=Turbo  [A][D]=Roll  [Q][E]=Lean  [F]=Display  [I]=Invert-Y [L]=Quality",L3D=LINES3D,P3D=POINTS3D,S3D=SHAPE3D,Z3=[0,0,0],RND=RANDOM,CDX=0,CDY=0,AP=Array.prototype;AP.p=AP.push,AP.random=()=>this[0|RAND(this.length)];var ACX=0,BUF=0,ADEST=0,AVOL=0,AT=0,ACHANNELS=[],READY=0,ASEQS=[[80,82,81,85,83],[80,80,82,80,84,84,85,85],[90,92,94,96,98,100],[70,69,68,67,66,65,64,63,62,61,60,59]],ASEQI=0,TALERT=0;PM=M4(),PPOS=PM.subarray(12,15),PFRONT=PM.subarray(8,11),PPOSXZ=V3(),PVEL=V3(Z3),PYAW=0,PPOWER=.5,PFORCE=0,PFUEL=1,PTURB=0,SHK=0,LIVES=4,HP=1,YAXIS=1,LOADED=0,PERSON=0,SCORE=0,TARGETS=[],ZOOM=1,ZL=[1,200,70,40,15],look=0,F=0,PREV=TIME(),NOW=PREV,Q=1,NBLOCKS=0,NDOTS=0,GTIME=0,NTIME=0,NTARGET=0;var eye=V3(),center=V3(),up=V3(),FOV=65;NEWCHANNEL=()=>{var P=ACX.createOscillator(),A=ACX.createBufferSource(),r=ACX.createBiquadFilter(),S=ACX.createGain();P.frequency.value=0,A.buffer=BUF,A.loop=!0,r.frequency.value=1e4,S.gain.value=0,P.connect(S),A.connect(r),r.connect(S),S.connect(AVOL);var E={osc:P,noise:A,filter:r,gain:S};return ACHANNELS.p(E),E},STARTAUDIO=()=>{ACX=new AudioContext,ADEST=ACX.destination,(AVOL=ACX.createGain()).gain.value=.5,AVOL.connect(ADEST);var P=2*ACX.sampleRate;BUF=ACX.createBuffer(1,P,ACX.sampleRate),data=BUF.getChannelData(0);for(var A=0;A<P;A++)data[A]=2*RANDOM()-1;for(A=0;A<3;++A)NEWCHANNEL();ACHANNELS[0].noise.start(),ACHANNELS[1].osc.start(),ACHANNELS[2].noise.start()};var dash=[[-3,-1,0],[3,-1,0],[4,-5,0],[2,-5,0],[2,-7,0],[-2,-7,0],[-2,-5,0],[-4,-5,0]];sqr=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]],glyV=[[0,2,0],[1,2,0],[0,1,0],[1,1,0],Z3,[1,0,0],[.5,1,0]],glyI=[[0,1,5,4,0],[2,1,5],[0,1,3,2,4,5],[0,1,2,5,4],[3,2,1,5],[1,0,2,3,5,4],[1,2,4,5,3,2],[0,1,4],[0,1,4,5,0],[3,2,0,1,5],[4,0,5,1],[1,0,2,3,2,4,5],[1,0,2,3,5,4],[0,4,6,5,1]],glys=[];for(i=0;i<14;++i){var n=[];glys.p(n);for(var j=0;j<glyI[i].length;++j)n.p(glyV[glyI[i][j]])}circle=[],circleY=[],circle4=[],circleR=[],stars=[],blocks={},grid=[];for(i=0;i<2*PI;i+=2*PI/100){var x=SIN(i),y=COS(i);circle.p(V3([x,y,0])),circleY.p(V3([x,0,y])),circle4.p(V3([SIN(i/4),0,COS(i/4)]))}for(i=1.4*PI;i<2.6*PI;)circleR.p(V3([SIN(i)*RAND(100,128),.5*RND(),COS(i)*RAND(100,128)])),i+=.03*RND();for(i=0;i<200;++i){var v=V3([RND()-.5,.4*(RND()-.5),RND()-.5]);v[1]<0&&(v[1]*=-1),stars.p(NORM(v,v))}var HOSPs=[[279,0,243],[581,0,465],[700,0,158],[848,0,414]],cars=[],Ps=[],roads=[],SMK=[],clouds=[],lightsW=[],lightsR=[];PM.set(HOSPs[0],12),INPUT(C),ADDL=(P,A)=>{var r=FLOOR(P[0]/64),S=FLOOR(P[2]/64),E=blocks[r+":"+S];E||(E=blocks[r+":"+S]={l:[]}),A?E.l.splice(FLOOR(E.l.length*RND()),0,P):E.l.p(P)},NEWROAD=(P,A,r,S,E,T)=>{var e=DIST(P,A);if(e>100){var R=LERPV3(V3(),P,A,.5);return NEWROAD(P,R,r,S,E,T),void NEWROAD(R,A,r,S,E,T)}roads.p(P,A),T=T||.5;for(var t=0;t<=e*T;++t){var O=LERPV3(V3(),P,A,(t+(E?RAND(.1,-.05):0))/(e*T));E&&(O=O.ADD([RAND(.1,-.05),.2,RAND(.1,-.05)])),r?r.p(O):ADDL(O,S)}},EMIT=(P,A,r)=>{var S=[V3(P),V3(A),r];return Ps.p(S),S};var city={lights:[],clouds:[]},lastR=roads.length;function extraWorld(){NEWROAD(V3([100,0,-1]),V3([150,0,-1]),lightsW),NEWROAD(V3([100,0,0]),V3([150,0,0]),lightsW,0,0,.5),NEWROAD(V3([100,0,1]),V3([150,0,1]),lightsW),NEWROAD(V3([98,0,-2.5]),V3([98,0,2.5]),lightsR);for(var P=0;P<HOSPs.length;++P){var A=HOSPs[P];NEWROAD(V3([-1.5,0,1]).ADD(A),V3([1.5,0,1]).ADD(A),lightsW,0,0,2),NEWROAD(V3([-1.5,0,-1]).ADD(A),V3([1.5,0,-1]).ADD(A),lightsW,0,0,2),NEWROAD(V3([.1,0,1]).ADD(A),V3([.1,0,-1]).ADD(A),lightsW,0,0,2)}}function SINGLEPOINTS3D(P,A,r,S){if(P&&P.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);for(var E=TEMPV4,T=VP_DATA,e=2,R=(r=r||1,0),t=P.length;R<t;R+=r)PROJ3D(E,MVP_M4,P[0|R]),E[0]<-.1||E[0]>1.1||E[1]<-.1||E[1]>1.1||E[2]>1||(e=PSIZE/POW(E[3],.8)*(S?1:1+R%3/3),CX.fillRect(REMAP(E[0],0,1,T[0],T[0]+T[2])-e/2,REMAP(E[1],1,0,0,T[1]+T[3])-e/2,e,e))}}fetch("barna.bin").then((P=>P.arrayBuffer())).then((P=>{for(var A=new Int16Array(P),r=0;r<A.length;r+=4)NEWROAD(V3([A[r]/2,0,A[r+1]/2]),V3([A[r+2]/2,0,A[r+3]/2]),0,1,1);lastR=roads.length,TARGETS=[],extraWorld()}));for(var ix=-8;ix<=8;++ix)for(var iz=-8;iz<=8;++iz)grid.p(V3([ix,0,iz]));loop=()=>{NBLOCKS=NDOTS=0,requestAnimationFrame(loop);var P=MOUSE.buttons,A=(MOUSE.pos[0]/C.width-.5)*(P?1:.5),r=YAXIS*(MOUSE.pos[1]/C.height-.5)*-(P?1:.5);P?READY||(READY=1,Ps.length=GTIME=0,!ACX&&LIVES&&STARTAUDIO(),NTIME=10):(CDX=A,CDY=r),NOW=TIME(),F++;var S=MIN(.1,NOW-PREV);PREV=NOW,GTIME+=S,NTIME-=S,C.width=BODY.offsetWidth,C.height=BODY.offsetHeight,INIT(C),CX.lineWidth=2,CX.globalCompositeOperation="lighter",READY?GTIME:(COLOR(6,(GTIME-2)/4),CX.font="200px Verdana",CX.textAlign="center",CX.fillText("EVAC3D",.5*C.width-8*MAX(0,5-NOW),.5*C.height),COLOR(0,1),CX.globalCompositeOperation="source-over",CX.fillText("EVAC3D",.5*C.width+4,.5*C.height+4),COLOR(6,(GTIME-6)/6),CX.font="30px Verdana",CX.textAlign="left",COLOR(8,.5*(GTIME-6)),CX.fillText("by @TAMAT for the #JK13K 2022",.5*C.width-240,C.height-40),F%2==0&&EMIT([410,0,240],[RAND(1,-.2)/3,.5+RAND(1),RAND(1,-.5)/3],8));var E=POW(1-SATURATE(GTIME/2-4),3);MAT4xV3(eye,PM,[0,.1,0]),MAT4xV3(up,PM,UP),SUB(up,up,eye),MAT4xV3(center,PM,[A*(1-E)+look,r*(1-E)+RAND(SHK),-1]),SHK*=.9,SCALE(PPOSXZ,PPOS,[1,0,1]),READY?(FOV=LERP(65,40,E),center[1]=LERP(center[1],0,E)):(eye=[50*SIN(NOW/9)+400,30,50*COS(NOW/8)+200],center=[410,0,200],up=[0,1,0]),CAMERA(eye,center,up,FOV,C.width/C.height,.1,500),COLOR(LIVES?"#AAC":1,1);var T=TMAT4(M4(),eye);PSIZE=1,LIVES?P3D(stars,T):L3D(stars,T),Q&&(COLOR(2),P3D(circleY,T,1),COLOR(8,.4),PSIZE=50,P3D(circleR)),PPOS[1]<4&&(COLOR(1,.3-.05*PPOS[1]),PSIZE=10,P3D(grid,TMAT4(M4(),[FLOOR(PPOS[0]),0,FLOOR(PPOS[2])]),1,1));for(var e=FLOOR(PPOS[0]/64),R=FLOOR(PPOS[2]/64),t=Q?6:3,O=-t+e;O<=t+e;O++)for(var M=-t+R;M<=t+R;M++){var a=64*O,i=64*M,o=DIST(PPOS,[a,PPOS[1],i]),D=blocks[O+":"+M];if(D&&CAMTESTBOX([a+32,0,i+32],[32,1,32])){NBLOCKS++;var L=D.l.length;o>750?L*=.25:o>500?L*=.5:o>250&&(L*=.75),Q&&(COLOR(8,.03),PSIZE=300,SINGLEPOINTS3D(D.l,0,1,0,L/4)),COLOR(8,.7),PSIZE=40,P3D(D.l,0,1,0,L),NDOTS+=L*(Q?1.5:1)|0}}cars=[];for(var n=0;n<lastR;n+=2){var l=roads[n],N=roads[n+1];if(!(DIST(eye,LERPV3(TEMPV3,l,N,.5))>150))for(var V=0,I=(o=DIST(l,N))>>1;V<=I;V++)_=FRACT((.3*NOW+V+SIN(123*V+.1*NOW))/I),cars.p(LERPV3(V3(),l,N,_))}if(TARGETS.forEach((P=>cars.p(P.pos))),COLOR(1),P3D(lightsW),COLOR("#F33",1),P3D(lightsR),!READY&&(F/10|0)%2){T=SIN(GTIME/10);PSIZE=-4,P3D([LERPV3(V3(),HOSPs[0],[410,0,240],T)])}F%5||!lightsW.length||lightsW.unshift(lightsW.pop()),F%5||!lightsR.length||lightsR.unshift(lightsR.pop()),COLOR(1,.4),PSIZE=40,P3D(cars,0,1,1),CX.globalCompositeOperation="source-over",COLOR(2,.5),PSIZE=LIVES?100:10,SINGLEPOINTS3D(SMK,0,1,1),COLOR(2,.5),Q&&(PSIZE=200,SINGLEPOINTS3D(clouds)),PSIZE=50,SMK=[];for(var c=0;c<Ps.length;++c){var h=Ps[c];SMK.p(h[0]),ADD(h[0],h[0],h[1].SCALE(S)),h[2]-=S}if(Ps=Ps.filter((P=>P[2]>0)),TARGETS.forEach((P=>{!(F%10|0)&&P.time<100&&EMIT(P.pos,[RAND(1,-.2)/9,.2+RAND(1,-.5)/6,RAND(1,-.5)/9],20)})),PPOS[1]<2&&PFORCE>1&&HP&&EMIT([PPOS[0],0,PPOS[2]],[RAND(1,-.5),0,RAND(1,-.5)],4),HP<.2&&!(F%10)&&LIVES&&EMIT(PPOS,Z3,6),READY){LIVES&&(COLOR(8,1),S3D(circle4,TRS(0,[0,20,0],[0,POW(NOW,3),0],40,PM),1),S3D(circle4,TRS(0,[0,20,0],[0,POW(NOW,4)+PI/2,0],30,PM),1));var v=APPLYTRANS(M4(),PM,[0,3*E-2,-10]),f=TRS(0,[0,7,0],0,[.8,-1,.8],v);COLOR(0,1),S3D(dash,f),COLOR(2),S3D(dash,f,1,1);f=TRS(0,[0,-8,0],0,[1,3,1],v);COLOR(0,1),S3D(sqr,f),COLOR(2),S3D(sqr,f,1,1),COLOR(0,1),S3D(dash,v),COLOR(2),S3D(dash,v,1,1),PYAW=ATAN2(PFRONT[0],PFRONT[2]);var u=[],g=[];(PFUEL<.1&&(F/4|0)%2||PTURB>.1)&&g.p([0,-2.35,0]);var p=TARGETS.filter((P=>P.mode));for(c=0;c<p.length;++c)(p[c].time>50||F/2%2)&&g.p([-1.1-.2*c,-1.1,0]);u.p([-2.5,-2,0],[.5*SIN(PPOS[1])-2.5,.5*COS(PPOS[1])-2,0],[-2.5,-2,0],[.3*SIN(PPOS[1]/10)-2.5,.3*COS(PPOS[1]/10)-2,0],[0,-2,0],[.45*SIN(4.2*PFUEL-2.2),.45*COS(4.2*PFUEL-2.2)-2,0]);var d=.52;PSIZE=-2,S3D(circle,TRS(0,[-2.5,-2,0],0,d,v),1,1),P3D(circle,TRS(0,[-2.5,-2,0],0,d-.1,v),5,1),S3D(circle,TRS(0,[-1.25,-2,0],0,d,v),1,1),S3D(circle,TRS(0,[0,-2,0],0,d,v),1,1),m=circle.slice(0,70),S3D(m,TRS(0,[0,-2,0],[0,0,2.2],d-.05,v),1,1),P3D(m,TRS(0,[0,-2,0],[0,0,2.2],.44,v),2,1),S3D(sqr,TRS(0,[2,-3,0],0,[1,.1,0],v),1,1),S3D(sqr,TRS(0,[2,-3.3,0],0,[1,.1,0],v),1,1),S3D(sqr,TRS(0,[2,-3.6,0],0,[1,.1,0],v),1,1),S3D(sqr,TRS(0,[1.9,-.6,0],0,[.5,.01,0],v)),S3D(sqr,TRS(0,[1.9,-.6,0],0,[.01,.5,0],v)),S3D(sqr,TRS(0,[-1.2,-3.8,0],0,[2,1,0],v),1,1),COLOR(3,.2),PSIZE=50;var U=TRS(0,[0,-.2,0],0,1,v);if(S3D(sqr,U),S3D(sqr,TRS(0,[1.9,-.6,0],0,.5,v)),TARGETS.forEach((P=>P.dist=DIST(P.pos,PPOS))),TARGETS.sort(((P,A)=>P.dist-A.dist)),NTARGET=TARGETS[0],COLOR("#585",1),LIVES||RND()>(LIVES&&HP<.25?.5:.9)){if((LOADED>=1||TARGETS[0]&&(TARGETS[0].dist>1.5||(F/8|0)%2==0))&&S3D(sqr,TRS(0,[0,-1.3,0],0,[CLAMP(4-TARGETS[0].dist,0,2),.02,.1],v)),GTIME>3.5){L3D(u,v,1);var X=TRS(0,[-1.25,-2,0],[0,0,-PYAW-PI/2],.1,v);S3D(glys[10],X.MULT(TMAT4(M4(),[-.5,2,0])),1),S3D(glys[11],X.MULT(TMAT4(M4(),[3,-1,0])),1),S3D(glys[12],X.MULT(TMAT4(M4(),[-.5,-4,0])),1),S3D(glys[13],X.MULT(TMAT4(M4(),[-4,-1,0])),1)}if(1==E){MULTMAT4(MVP_M4,VP_M4,v);var W=TOVIEWPORT(V3(),PROJ3D(V3(),MVP_M4,[-2.9,-3.1,0]));CX.font="20px Courier New";for(c=0;c<MIN(HELP.length,HELP.length*GTIME*.25|0);++c)CX.fillText(HELP[c],W[0],W[1]+20*c)}if(GTIME>8){var _=SATURATE(PPOWER/2);S3D(sqr,TRS(0,[1+_,-3,0],0,[_,.1,0],v)),S3D(sqr,TRS(0,[3*PTURB+1,-3.3,0],0,[3*PTURB,.1,0],v)),S3D(sqr,TRS(0,[HP+1,-3.6,0],0,[HP,.1,0],v)),DRAWNUM=(P,A,r)=>{for(var S=0;S<4;++S)S3D(glys[(P/POW(10,3-S)|0)%10],TRS(0,[A+S/2,r,0],0,.2,v),1)},DRAWNUM(SCORE,-2.4,-3.3)}CX.save(),S3D(sqr,APPLYSCALE(0,U,[.9,.9,.9]),0,0,1),s=ZL[ZOOM];var Y=SMAT4(M4(),1/s).MULT(RMAT4(M4(),-PYAW,UP).MULT(TMAT4(M4(),[-PPOS[0],0,-PPOS[2]]))),y=TRS(0,Z3,[PI/2,0,0],1,U);y=y.MULT(Y),ZOOM||(y=0,PSIZE=-8),GTIME>5&&L3D(roads,y,1),P3D(HOSPs,y),COLOR(1);var G=TARGETS.filter((P=>!P.incopter&&P.mode)).map((P=>P.time<100?P.pos:P.pos2));if(G[0]&&(10*NOW|0)%2==0&&P3D(G,y),ALPHA(.5),TARGETS.forEach((P=>{!P.incopter&&P.mode&&S3D(circleY,TRS(0,P.pos2,0,10,y),1,1)})),PSIZE=40,CX.restore(),COLOR(6,1),GTIME>3&&S3D(sqr,TRS(0,Z3,0,.03,U)),lvel=RMAT4(M4(),-PYAW,[0,1,0]).MULT(PVEL),S3D(sqr,TRS(0,[1.9+CLAMP(lvel[0]/1.5,-.5,.5),-.6-CLAMP(lvel[2]/1.5,-.5,.5),0],0,.02,v)),S3D(sqr,TRS(0,[1.45,-.6+CLAMP(PVEL[1],-.5,.5),0],0,[-.05,.02,0],v)),X=TRS(0,[2,-2,0],0,.5,v),PERSON){pulse=[];var H=POW(CLAMP(PERSON.time/100,0,1),.4);for(c=0;c<40;++c)pulse.p(V3([c/20-1,CLAMP(SIN(c/5+NOW)*SIN(c/2+4*NOW)*H,-.8,.8),0]));S3D(pulse,X,1)}for(c=0;c<LIVES;++c)g.p([1.2,c/4-2.4,0]);P3D(g,v,1,1),COLOR(2),S3D(sqr,X,1,1)}if(READY&&GTIME<20&&(COLOR(6,2-GTIME/10),CX.font="16px Arial",CX.textAlign="left",CX.fillText(HELP_KEYS,10,20)),ACX){T=ACX.currentTime;var m=0;TALERT-=S,copter=ACHANNELS[0],radio=ACHANNELS[1],turbo=ACHANNELS[2],copter.filter.frequency.linearRampToValueAtTime(300*PPOWER+1e3*SHK,T+.1),AT+=S*PFORCE*10+RANDOM()*SHK*10,m=.4*FRACT(AT)+.2*SHK,copter.gain.gain.linearRampToValueAtTime(CLAMP(m,0,1),T+.1);var B=TALERT>0?ASEQS[ASEQI][(10*NOW|0)%ASEQS[ASEQI].length]:0,K=440*POW(2,(B-69)/12);radio.osc.frequency.linearRampToValueAtTime(K,T+.1),radio.gain.gain.value=.5,turbo.filter.frequency.linearRampToValueAtTime(500*PTURB+4e3,T+.1),turbo.gain.gain.linearRampToValueAtTime(PTURB,T+.1)}if(LIVES){SPD=LEN(PVEL),PPOS[1]<0&&((SPD>.1||ABS(PFRONT[1])<-.5)&&(HP=MAX(0,HP-(.05+SPD/2)),SHK=4*SPD),TRS(PM,V3([PPOS[0],0,PPOS[2]]),[0,PYAW,0],1),PVEL.fill(0)),HP<=0&&(LIVES=0),angz=0,GTIME>6&&(KEYS.W&&(PPOWER+=.2*S),KEYS.S&&(PPOWER-=.2*S),KEYS.A&&(angz-=S/3),KEYS.D&&(angz+=S/3),KEYS.Space&&(PTURB=SATURATE(PTURB+2*S))),KEYS.Q?look=LERP(look,-1,.1):KEYS.E?look=LERP(look,1,.1):look=LERP(look,0,.1),KEYSP={};var Z=M4(PM);if(Z.set(Z3,12),PPOWER=CLAMP(PPOWER,0,2),PFORCE=LERP(PFORCE,PPOWER+3*PTURB,.2),PFUEL=MAX(0,PFUEL-(PPOWER+100*PTURB)*S*.001),PTURB*=.9,_=Z.MULT([0,S*S*PFORCE*(PFUEL?25:0),0]),ADD(PVEL,PVEL,V3([0,-(24+LOADED+.5*PPOS[1])*S*S,0]).ADD(_)),SCALE(PVEL,PVEL,.995),PPOS[1]<=0&&(PVEL[1]=MAX(0,PVEL[1])),T=TMAT4(M4(),PVEL.SCALE(.2)),rx=RMAT4(M4(),.15*-CDX,[0,1,0]),rz=RMAT4(M4(),.1*CDX+angz,[0,0,-1]),ry=RMAT4(M4(),.05*CDY,[1,0,0]),b=MULTMAT4(M4(),rx,ry),MULTMAT4(b,rz,b),PPOS[1]>0&&MULTMAT4(PM,PM,b),MULTMAT4(PM,T,PM),NTARGET&&NTARGET.dist<1.5&&PPOS[1]<=0&&LOADED<1&&(LOADED+=S/2,LOADED>=1&&(NTARGET.incopter=1,PERSON=NTARGET,TARGETS.shift(),ASEQI=2,TALERT=.8)),TARGETS.forEach((P=>{P.time-=S,RANDOM()>.001&&!P.mode&&(P.mode=1,TALERT=.8,ASEQI=0),P.time<=0&&(LIVES--,NTIME<0&&(NTIME=10),P==PERSON&&(LOADED=PERSON=0),TALERT=.8,ASEQI=3)})),TARGETS=TARGETS.filter((P=>P.time>0)),TARGETS.length<4&&roads[0]&&NTIME<0){var b=2*(0|RAND(lastR/2)),w=LERPV3(V3(),roads[b],roads[b+1],RND()),x=w.ADD([16*(RANDOM()-.5),0,16*(RANDOM()-.5)]);TARGETS.p({pos:w,pos2:x,time:200+RAND(50),mode:0,incopter:0}),NTIME=30}INH=0;for(c=0;c<HOSPs.length;++c)INH|=DIST(PPOS,HOSPs[c])<2;PPOS[1]<=0&&INH&&(LOADED>=1&&PERSON&&(SCORE+=PERSON.time/2|0,PERSON=LOADED=0,TALERT=ASEQI=1),PFUEL=MIN(1,PFUEL+S/20))}else ACX&&(ACX.close(),ACX=0)}},loop(),ONKEY=P=>{if("keydown"==P.type)switch(P.code){case"KeyI":YAXIS*=-1;break;case"KeyL":Q=!Q;break;case"KeyF":ZOOM=(ZOOM+1)%5}}</script>
