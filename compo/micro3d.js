var KEYS={},KEYSP={},MOUSE={pos:[0,0],delta:[0,0],buttons:0},CX=0,BODY=document.body;BODY.onkeydown=BODY.onkeyup=function(M){var A="keydown"==M.type,P="Key"==M.code.substr(0,3)?M.code.substr(3):M.code;KEYSP[P]=A&&!KEYS[P],KEYS[P]=A,window.ONKEY&&ONKEY(M)};var D2R=.0174532925,PSIZE=50,maths=Object.getOwnPropertyNames(Math);for(var i in maths)window[maths[i].toUpperCase()]=Math[maths[i]];CLAMP=(M,A,P)=>MIN(MAX(M,A),P),SATURATE=M=>CLAMP(M,0,1);var F32=Float32Array,F32P=F32.prototype,IDM4=new F32([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);F32P.MULT=function(M){return 16==M.length?MULTMAT4(M4(),this,M):16==this.length?MAT4xV3(V3(),this,M):V3([this[0]*M[0],this[1]*M[1],this[2]*M[2]])},F32P.ADD=function(M){return ADD(V3(),this,M)},F32P.SUB=function(M){return SUB(V3(),this,M)},F32P.SCALE=function(M){return SCALE(V3(),this,M)},PALETTE=["#000","#FFF","#333","#777","#AAA","#FAA","#AFA","#AAF","#FD9"],V3=M=>new F32(M||3),UP=V3([0,1,0]),M4=M=>new F32(M||IDM4);var VP_DATA=new F32(4),TEMPV3=V3(),TEMPV3B=V3(),TEMPV4=V3(4);INIT=M=>{CX=M.getContext("2d"),VP_DATA.set([0,0,M.width,M.height]),M.width=M.width,M.height=M.height},INPUT=M=>{M.onmousedown=M.onmouseup=M.onmousemove=function(M){MOUSE.delta[0]=M.pageX-MOUSE.pos[0],MOUSE.delta[1]=M.pageY-MOUSE.pos[1],MOUSE.pos[0]=M.pageX,MOUSE.pos[1]=M.pageY,MOUSE.buttons=M.buttons,window.ONMOUSE&&ONMOUSE(M)}},VIEWPORT=(M,A,P,T)=>{VP_DATA.set([M,A,P,T])},TIME=()=>.001*performance.now(),LERP=(M,A,P)=>M*(1-P)+A*P,ILERP=(M,A,P)=>(P-M)/(A-M),REMAP=(M,A,P,T,r)=>LERP(T,r,ILERP(A,P,M)),RAND=(M,A)=>RANDOM()*M+(A||0),FRACT=M=>M-FLOOR(M),ADD=(M,A,P)=>(M[0]=A[0]+P[0],M[1]=A[1]+P[1],M[2]=A[2]+P[2],M),SUB=(M,A,P)=>(M[0]=A[0]-P[0],M[1]=A[1]-P[1],M[2]=A[2]-P[2],M),SCALE=(M,A,P)=>(P.length?(M[0]=A[0]*P[0],M[1]=A[1]*P[1],M[2]=A[2]*P[2]):(M[0]=A[0]*P,M[1]=A[1]*P,M[2]=A[2]*P),M),DOT=(M,A)=>M[0]*A[0]+M[1]*A[1]+M[2]*A[2],CROSS=(M,A,P)=>{var T=A[0],r=A[1],t=A[2],E=P[0],e=P[1],S=P[2];return M[0]=r*S-t*e,M[1]=t*E-T*S,M[2]=T*e-r*E,M},LEN=M=>{var A=M[0],P=M[1],T=M[2];return SQRT(A*A+P*P+T*T)},LERPV3=(M,A,P,T)=>{for(var r=0;r<M.length;++r)M[r]=A[r]*(1-T)+P[r]*T;return M},NORM=(M,A)=>{var P=A[0],T=A[1],r=A[2],t=P*P+T*T+r*r;return t>0&&(t=1/SQRT(t),M[0]=A[0]*t,M[1]=A[1]*t,M[2]=A[2]*t),M},DIST=(M,A)=>{var P=A[0]-M[0],T=A[1]-M[1],r=A[2]-M[2];return SQRT(P*P+T*T+r*r)},TMAT4=(M,A)=>(M.set(IDM4),M[12]=A[0],M[13]=A[1],M[14]=A[2],M),RMAT4=(M,A,P)=>{var T,r,t,E=P[0],e=P[1],S=P[2],n=SQRT(E*E+e*e+S*S);return n<1e-4?null:(E*=n=1/n,e*=n,S*=n,T=SIN(A),t=1-(r=COS(A)),M[0]=E*E*t+r,M[1]=e*E*t+S*T,M[2]=S*E*t-e*T,M[3]=0,M[4]=E*e*t-S*T,M[5]=e*e*t+r,M[6]=S*e*t+E*T,M[7]=0,M[8]=E*S*t+e*T,M[9]=e*S*t-E*T,M[10]=S*S*t+r,M[11]=0,M[12]=0,M[13]=0,M[14]=0,M[15]=1,M)},SMAT4=(M,A)=>(A.constructor===Number&&(A=[A,A,A]),M.set(IDM4),M[0]=A[0],M[5]=A[1],M[10]=A[2],M),APPLYTRANS=(M,A,P)=>{var T=TMAT4(M4(),P);return MULTMAT4(M||T,A,T)},APPLYROT=(M,A,P,T)=>{var r=RMAT4(M4(),P,T);return MULTMAT4(M||r,A,r)},APPLYSCALE=(M,A,P)=>{var T=SMAT4(M4(),P);return MULTMAT4(M||T,A,T)},TRS=(M,A,P,T,r)=>{M=M||M4();var t=TMAT4(M4(),A),E=M4();P&&(P[0]&&APPLYROT(E,E,P[0],[1,0,0]),P[1]&&APPLYROT(E,E,P[1],[0,1,0]),P[2]&&APPLYROT(E,E,P[2],[0,0,1]));var e=SMAT4(M4(),T);return MULTMAT4(M,r||M4(),t),MULTMAT4(M,M,E),MULTMAT4(M,M,e)},MULTMAT4=(M,A,P)=>{var T=A[0],r=A[1],t=A[2],E=A[3],e=A[4],S=A[5],n=A[6],R=A[7],o=A[8],O=A[9],V=A[10],a=A[11],L=A[12],C=A[13],i=A[14],_=A[15],u=P[0],N=P[1],v=P[2],I=P[3];return M[0]=u*T+N*e+v*o+I*L,M[1]=u*r+N*S+v*O+I*C,M[2]=u*t+N*n+v*V+I*i,M[3]=u*E+N*R+v*a+I*_,u=P[4],N=P[5],v=P[6],I=P[7],M[4]=u*T+N*e+v*o+I*L,M[5]=u*r+N*S+v*O+I*C,M[6]=u*t+N*n+v*V+I*i,M[7]=u*E+N*R+v*a+I*_,u=P[8],N=P[9],v=P[10],I=P[11],M[8]=u*T+N*e+v*o+I*L,M[9]=u*r+N*S+v*O+I*C,M[10]=u*t+N*n+v*V+I*i,M[11]=u*E+N*R+v*a+I*_,u=P[12],N=P[13],v=P[14],I=P[15],M[12]=u*T+N*e+v*o+I*L,M[13]=u*r+N*S+v*O+I*C,M[14]=u*t+N*n+v*V+I*i,M[15]=u*E+N*R+v*a+I*_,M},LOOKAT=(M,A,P,T)=>{var r=void 0,t=void 0,E=void 0,S=void 0,n=void 0,R=void 0,o=void 0,O=void 0,V=void 0,a=void 0,L=A[0],C=A[1],i=A[2],_=T[0],u=T[1],N=T[2],v=P[0],I=P[1],D=P[2];return ABS(L-v)<1e-4&&ABS(C-I)<1e-4&&ABS(i-D)<1e-4?e(M):(o=L-v,O=C-I,V=i-D,r=u*(V*=a=1/SQRT(o*o+O*O+V*V))-N*(O*=a),t=N*(o*=a)-_*V,E=_*O-u*o,(a=SQRT(r*r+t*t+E*E))?(r*=a=1/a,t*=a,E*=a):(r=0,t=0,E=0),S=O*E-V*t,n=V*r-o*E,R=o*t-O*r,(a=SQRT(S*S+n*n+R*R))?(S*=a=1/a,n*=a,R*=a):(S=0,n=0,R=0),M[0]=r,M[1]=S,M[2]=o,M[3]=0,M[4]=t,M[5]=n,M[6]=O,M[7]=0,M[8]=E,M[9]=R,M[10]=V,M[11]=0,M[12]=-(r*L+t*C+E*i),M[13]=-(S*L+n*C+R*i),M[14]=-(o*L+O*C+V*i),M[15]=1,M)},PERSP=(M,A,P,T,r)=>{var t=1/TAN(A*D2R/2),E=void 0;return M[0]=t/P,M[1]=0,M[2]=0,M[3]=0,M[4]=0,M[5]=t,M[6]=0,M[7]=0,M[8]=0,M[9]=0,M[11]=-1,M[12]=0,M[13]=0,M[15]=0,null!=r&&r!==1/0?(E=1/(T-r),M[10]=(r+T)*E,M[14]=2*r*T*E):(M[10]=-1,M[14]=-2*T),M},TRANS3D=(M,A,P)=>{var T=A[0],r=A[1],t=A[2],E=P[3]*T+P[7]*r+P[11]*t+P[15];return E=E||1,M[0]=(P[0]*T+P[4]*r+P[8]*t+P[12])/E,M[1]=(P[1]*T+P[5]*r+P[9]*t+P[13])/E,M[2]=(P[2]*T+P[6]*r+P[10]*t+P[14])/E,M},PROJ3D=(M,A,P)=>{var T=P[0],r=P[1],t=P[2],E=A[0]*T+A[4]*r+A[8]*t+A[12],e=A[1]*T+A[5]*r+A[9]*t+A[13],S=A[2]*T+A[6]*r+A[10]*t+A[14],n=A[3]*T+A[7]*r+A[11]*t+A[15];return M[0]=(E/n+1)/2,M[1]=(e/n+1)/2,M[2]=(S/n+1)/2,M.length>3&&(M[3]=n),M},TOVIEWPORT=(M,A)=>{var P=VP_DATA;return M[0]=REMAP(A[0],0,1,P[0],P[0]+P[2]),M[1]=REMAP(A[1],1,0,0,P[1]+P[3]),M},MAT4xV3=(M,A,P)=>{var T=P[0],r=P[1],t=P[2];return M[0]=A[0]*T+A[4]*r+A[8]*t+A[12],M[1]=A[1]*T+A[5]*r+A[9]*t+A[13],M[2]=A[2]*T+A[6]*r+A[10]*t+A[14],M},ALPHA=M=>{CX.globalAlpha=M},COLOR=(M,A)=>{M.constructor===Number&&(M=PALETTE[0|M]),CX.fillStyle=CX.strokeStyle=M,null!=A&&(CX.globalAlpha=CLAMP(A,0,1))};var VIEW_M4=M4(),PROJ_M4=M4(),VP_M4=M4(),MVP_M4=M4(),FPLANES=0,CAM_EYE=V3(),CAM_CENTER=V3(),CAM_FRONT=V3(),CAM_RIGHT=V3();function POINTS3D(M,A,P,T,r){if(M&&M.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var t=TEMPV4,E=VP_DATA,e=2;P=P||1;CX.beginPath();for(var S=0,n=MIN(r||M.length,M.length);S<n;S+=P)PROJ3D(t,MVP_M4,M[0|S]),t[0]<-.1||t[0]>1.1||t[1]<-.1||t[1]>1.1||t[2]>1||t[2]<0||(e=PSIZE<0?-PSIZE:PSIZE/POW(t[3],.8)*(T?1:1+S%3/3))<.1||CX.rect(REMAP(t[0],0,1,E[0],E[0]+E[2])-e/2,REMAP(t[1],1,0,0,E[1]+E[3])-e/2,e,e);CX.fill()}}function SHAPE3D(M,A,P,T,r){if(M&&M.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var t=TEMPV3,E=VP_DATA;CX.beginPath();for(var e=0,S=M.length;e<S;e+=1)PROJ3D(t,MVP_M4,M[e]),t[0]<-1||t[0]>2||t[1]<-1||t[1]>2||t[2]>1||t[2]<-1||CX.lineTo(REMAP(t[0],0,1,E[0],E[0]+E[2]),REMAP(t[1],1,0,0,E[1]+E[3]));T&&CX.closePath(),r?CX.clip():P?CX.stroke():CX.fill()}}function LINES3D(M,A){if(M&&M.length){A?MULTMAT4(MVP_M4,VP_M4,A):MVP_M4.set(VP_M4);var P=TEMPV3,T=TEMPV3B,r=VP_DATA;CX.beginPath();for(var t=0;t<M.length-1;t+=2)PROJ3D(P,MVP_M4,M[t]),PROJ3D(T,MVP_M4,M[t+1]),P[2]>1||P[2]<0||T[2]>1||T[2]<0||(CX.moveTo(REMAP(P[0],0,1,r[0],r[0]+r[2]),REMAP(P[1],1,0,0,r[1]+r[3])),CX.lineTo(REMAP(T[0],0,1,r[0],r[0]+r[2]),REMAP(T[1],1,0,0,r[1]+r[3])));CX.stroke()}}CAMERA=(M,A,P,T,r,t,E)=>{CAM_EYE.set(M),CAM_CENTER.set(A),SUB(CAM_FRONT,CAM_CENTER,CAM_EYE),NORM(CAM_FRONT,CAM_FRONT),CROSS(CAM_RIGHT,CAM_FRONT,P),NORM(CAM_RIGHT,CAM_RIGHT),LOOKAT(VIEW_M4,M,A,P),PERSP(PROJ_M4,T,r,t,E),MULTMAT4(VP_M4,PROJ_M4,VIEW_M4),EXTRACTPLANES(VP_M4)},EXTRACTPLANES=M=>{FPLANES=[];for(var A=0;A<6;++A){var P=A%2?1:-1,T=A>>1,r=new F32([M[3]+P*M[T],M[7]+P*M[4+T],M[11]+P*M[8+T],M[15]+P*M[12+T]]),t=LEN(r);if(t){for(T=0;T<4;++T)r[T]/=t;FPLANES.p(r)}}};var IS_OUTSIDE=0,IS_INSIDE=1,OVERLAPS=2;DISTTOPLANE=(M,A)=>DOT(M,A)+M[3],CAMTESTSPHERE=(M,A)=>{FPLANES||EXTRACTPLANES(VP_M4);for(var P,T=0,r=0;r<6;++r){if((P=DISTTOPLANE(FPLANES[r],M))<-A)return IS_OUTSIDE;P<=A&&(T=1)}return T?OVERLAPS:IS_INSIDE},PLANEOVERLAP=(M,A,P)=>{var T=ABS(P[0]*M[0])+ABS(P[1]*M[1])+ABS(P[2]*M[2]),r=DOT(M,A)+M[3];return r<=-T?0:r<=T?OVERLAPS:IS_INSIDE},CAMTESTBOX=(M,A)=>{FPLANES||EXTRACTPLANES(VP_M4);for(var P=0,T=0,r=0;r<6;++r){if(!(P=PLANEOVERLAP(FPLANES[r],M,A)))return 0;T+=2==P?1:0}return T?OVERLAPS:IS_INSIDE};
